% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/harmonize_parquet_schemata.R
\name{harmonize_parquet_schemata}
\alias{harmonize_parquet_schemata}
\title{Harmonize Parquet Schemas In-Place}
\usage{
harmonize_parquet_schemata(root_dir, compression = "SNAPPY", verbose = TRUE)
}
\arguments{
\item{root_dir}{Character path to the root directory containing Parquet
files. Can be hive-partitioned (e.g. `page=1/`, `page=2/`, …) or flat;
the function always scans recursively.}

\item{compression}{Parquet compression codec. Default `"SNAPPY"`.}

\item{verbose}{Logical; whether to report progress. Default `TRUE`.}
}
\value{
Invisibly returns `TRUE` on success.
}
\description{
Inspect every Parquet file inside a (possibly hive-partitioned) directory,
infer a *global unified schema* across all files, and rewrite only those
files whose column types deviate from this global schema.
}
\details{
Directory structure and file names are preserved. Only files with
mismatched column types are rewritten.

Typical use case: large JSON → Parquet ingestion pipelines where DuckDB
infers slightly different types for rare fields across pages (e.g. `fwci`
sometimes `INT`, sometimes `DOUBLE`).


The function performs three steps:

\enumerate{
  \item Uses DuckDB to infer a *global schema* across all Parquet files via
  \code{DESCRIBE SELECT * FROM parquet_scan('root_dir/**/*.parquet')}.

  \item For each file, obtains its *local schema* via
  \code{DESCRIBE SELECT * FROM parquet_scan('file')}.

  \item If any column has a different type from the global type, rewrites
  that file using:

  \preformatted{
  SELECT
    *
    REPLACE (
      CAST(col AS global_type) AS col,
      ...
    )
  FROM parquet_scan('file')
  }

  and writes it to a temporary Parquet file, which then atomically
  replaces the original.
}

Missing columns are *not* rewritten; Parquet readers naturally treat them as
nullable and fill `NULL`s where absent. Only mismatched column *types*
trigger a rewrite.

If the `progressr` package is installed and `verbose = TRUE`, a progress bar
is shown; otherwise files are processed in a simple loop.
}
\examples{
\dontrun{
harmonize_parquet_schemata("data/hive_dataset")
}

}
